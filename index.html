<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="UTF-8"> 
<title>E-Clip</title>

<style>
body {
  background:#1e1e1e;
  color:#d4d4d4;
  font-family:Segoe UI,sans-serif;
  padding:10px;
  display:flex;
  flex-direction:column;
  align-items:center;
}
h1 { color:#61dafb; }

textarea {
  width:100%;
  max-width:1000px;
  height:300px;
  background:#252526;
  color:#d4d4d4;
  border:1px solid #333;
  border-radius:5px;
  padding:10px;
  font-family:monospace;
}

button {
  margin:5px;
  padding:10px 15px;
  background:#0e639c;
  color:white;
  border:none;
  border-radius:5px;
  cursor:pointer;
}

input {
  width:100%;
  max-width:1000px;
  margin-top:10px;
  padding:10px;
  background:#252526;
  border:1px solid #333;
  color:#61dafb;
}
</style>
</head>

<body>

<h1>E-Clip</h1>

<textarea id="input" placeholder="Paste text here"></textarea>

<div>
  <button onclick="generate()">Generate Link (5 min)</button>
  <button onclick="copyLink()">Copy Link</button>
</div>

<input id="link" readonly onclick="this.select()">

<script>
const EXPIRY_MS = 5 * 60 * 1000;
const input = document.getElementById("input");
const link = document.getElementById("link");

/* ---------- Compression helpers ---------- */
async function compress(text) {
  if (!("CompressionStream" in window)) {
    throw new Error("Compression not supported");
  }
  const cs = new CompressionStream("gzip");
  const writer = cs.writable.getWriter();
  writer.write(new TextEncoder().encode(text));
  writer.close();
  const buffer = await new Response(cs.readable).arrayBuffer();
  return btoa(String.fromCharCode(...new Uint8Array(buffer)));
}

async function decompress(base64) {
  const bytes = Uint8Array.from(atob(base64), c => c.charCodeAt(0));
  const ds = new DecompressionStream("gzip");
  const writer = ds.writable.getWriter();
  writer.write(bytes);
  writer.close();
  const buffer = await new Response(ds.readable).arrayBuffer();
  return new TextDecoder().decode(buffer);
}

/* ---------- Generate link ---------- */
async function generate() {
  if (!input.value) {
    alert("Paste some text first");
    return;
  }

  try {
    const compressed = await compress(input.value);
    const payload = {
      t: Date.now(),
      d: compressed
    };

    const encoded = btoa(JSON.stringify(payload));
    link.value = location.origin + location.pathname + "#e=" + encoded;
  } catch (err) {
    alert("Compression not supported in this browser");
  }
}

/* ---------- Load from URL ---------- */
async function load() {
  if (!location.hash.startsWith("#e=")) return;

  try {
    const payload = JSON.parse(atob(location.hash.slice(3)));

    if (Date.now() - payload.t > EXPIRY_MS) {
      alert("❌ Link expired");
      return;
    }

    input.value = await decompress(payload.d);
    alert("✅ Text loaded (expires in 5 minutes)");
  } catch {
    alert("❌ Invalid or truncated link");
  }
}

function copyLink() {
  if (!link.value) {
    alert("Generate the link first");
    return;
  }
  navigator.clipboard.writeText(link.value);
  alert("Link copied");
}

load();
</script>

</body>
</html>
